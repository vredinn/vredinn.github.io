document.addEventListener("DOMContentLoaded",(()=>{fetch("/js/cakeOptions.json").then((e=>e.json())).then((e=>{window.cakeOptions=e,addLayer()})).catch((e=>{})),document.querySelector(".button_add-layer").addEventListener("click",addLayer),document.querySelector("#comment").addEventListener("change",(()=>{document.querySelector("#comment").value.trim()?document.querySelector("#cake-info__comment").textContent="Дополнительный комментарий: "+document.querySelector("#comment").value:(document.querySelector("#cake-info__comment").textContent="",document.querySelector("#comment").value=null)}));const e=document.querySelector(".button_order-custom"),t=document.querySelector(".modal_custom"),n=document.querySelector(".modal__form_custom"),a=document.getElementById("order-cancel_custom"),i=document.getElementById("order-submit_custom"),o=()=>{t.classList.toggle("modal_active"),n.classList.toggle("modal__form_active")};t.addEventListener("click",(e=>{n.contains(e.target)||o()})),e.addEventListener("click",o),i.addEventListener("click",(()=>{o()})),a.addEventListener("click",(()=>{o()}));const l=document.querySelector(".cake-info__layers-info");l.addEventListener("mousedown",(e=>{function t(e){dragging(e,l)}dragStart(e,l),window.addEventListener("mousemove",t),window.addEventListener("mouseup",(function e(){dragStop(l),window.removeEventListener("mousemove",t),window.removeEventListener("mouseup",e)}))}))}));let startX,startScrollLeft,isDragging=!1;function dragStart(e,t){isDragging=!1,startX=e.pageX||e.touches[0].pageX,startScrollLeft=t.scrollLeft}function dragging(e,t){const n=e.pageX||e.touches[0].pageX;Math.abs(n-startX)>1&&(isDragging=!0,document.body.style.setProperty("cursor","grab")),isDragging&&(t.scrollLeft=startScrollLeft-(n-startX))}function dragStop(e){setTimeout((()=>{isDragging=!1,document.body.removeAttribute("style")}),0)}function addLayer(){if(!window.cakeOptions)return;const e=document.querySelectorAll(".layer");if(5===e.length)return;4===e.length&&(document.querySelector(".button_add-layer").classList.toggle("disabled"),document.querySelector(".button_add-layer").classList.toggle("button_center"));const t=document.createElement("div");t.classList.add("layer","row","mb-2","align-items-center","box-shadow");const n=window.cakeOptions.fillings.map(((t,n)=>`\n        <label class="option mb-2">\n            <input class="option__input layer__base" type="radio" name="filling__${e.length+1}" value="${t.value}" data-price="${t.price}" ${0===n?"checked":""}>\n            <div class="option__card">\n                <div class="option__name">\n                    ${t.name}\n                </div>                \n                <div class="option__price">\n                    ${t.price} руб/кг\n                </div>\n                <img src="${t.image}" class="option__img option__img_circle" draggable="false">\n                <div class="option__info">\n                    ${t.description}\n                </div>\n            </div>\n        </label>`)).join(""),a=window.cakeOptions.shapes.map(((e,t)=>"shape_custom"==e.value?`\n        <label class="option mb-2">\n            <input class="option__input layer__shape" type="radio" value="${e.value}" ${0===t?"checked":""}>\n            <div class="option__card">\n                <div class="option__name">                    \n                    ${e.name}\n                </div>\n                <img src="${e.image}" class="option__img mb-2" draggable="false">\n                <input class="layer__shape_custom custom-text" placeholder="Свой вариант" type="text" maxlength="100">\n            </div>\n        </label>`:`\n        <label class="option mb-2">\n            <input class="option__input layer__shape" type="radio" value="${e.value}" ${0===t?"checked":""}>\n            <div class="option__card">\n                <div class="option__name">                    \n                    ${e.name}\n                </div>\n                <img src="${e.image}" class="option__img" draggable="false">\n            </div>            \n        </label>`)).join(""),i=window.cakeOptions.ingredients.map((e=>"ingridient_custom"==e.value?`\n        <label class="option mb-2">\n            <input type="checkbox" class="option__input layer__ingredient" value="${e.value}" data-price="${e.price}">\n            <div class="option__card">\n                <div class="option__name">\n                    ${e.name} \n                </div>\n                <div class="option__price">\n                    +${e.price} руб\n                </div>\n                <img src="${e.image}" class="option__img mb-2" draggable="false" >\n                <input type="text" maxlength="100" class="layer__custom-ingredient custom-text" placeholder="Свой вариант">\n            </div>\n        </label>`:`\n        <label class="option mb-2">\n            <input type="checkbox" class="option__input layer__ingredient" value="${e.value}" data-price="${e.price}">\n            <div class="option__card">\n                <div class="option__name">\n                    ${e.name} \n                </div>\n                <div class="option__price">\n                    +${e.price} руб\n                </div>\n                <img src="${e.image}" class="option__img" draggable="false">\n                <div class="option__info"">\n                    <p>${e.description}</p>\n                </div>\n            </div>\n        </label>`)).join(""),o=window.cakeOptions.decorations.map((e=>"decoration_custom"==e.value?`\n        <label class="option mb-2">\n            <input type="checkbox" class="option__input layer__decor" value="${e.value}" data-price="${e.price}">\n            <div class="option__card">\n                <div class="option__name">\n                    ${e.name} \n                </div>\n                <div class="option__price">\n                    +${e.price} руб\n                </div>\n                <img src="${e.image}" class="option__img mb-2" draggable="false">\n                <input type="text" maxlength="100" class="layer__custom-decoration custom-text" placeholder="Свой вариант">\n            </div>\n        </label>`:`\n        <label class="option mb-2">\n            <input type="checkbox" class="option__input layer__decor" value="${e.value}" data-price="${e.price}">\n            <div class="option__card">\n                <div class="option__name">\n                    ${e.name} \n                </div>\n                <div class="option__price">\n                    +${e.price} руб\n                </div>\n                <img src="${e.image}" class="option__img" draggable="false">\n                <div class="option__info">\n                    ${e.description}\n                </div>\n            </div>\n        </label>`)).join("");t.innerHTML=`\n    <div class="layer__header">\n        <h3 class="title title_pink text-center layer__title">Ярус ${document.querySelectorAll(".layer").length+1}</h3><span class="layer__title-arrow"></span>\n    </div>\n        <div class="layer__options">   \n            <div class="col-md-12 mb-2">\n                <div class="layer__option-title title_pink">Вес яруса:</div>\n                <div class="layer__weight-wrapper">\n                    <input type="range" class="form-control layer__weight" value="0.5" step="0.5" min="0.5" max="10" oninput="rangeInput(this)"/>\n                    <output id="weightvalue" class="layer__weight-value">\n                        <span class="layer__weight-text">0.5 кг</span>\n                    </output>\n                </div>                \n            </div>     \n            <div class="row">\n                <div class="col-lg-12 mb-2">\n                    <div class="layer__option-title title_pink">Наполнитель:</div>\n                    <div class="options-container">\n                        ${n} \n                    </div> \n                </div>\n\n                <div class="col-lg-12 mb-2">\n                    <div class="layer__option-title title_pink">Форма яруса:</div>\n                    <div class="options-container">                \n                        ${a}\n                    </div>\n                </div>\n            </div>\n\n            <div class="row">\n                <div class="col-lg-12 mb-2">\n                    <div class="layer__option-title title_pink">Начинка:</div>\n                    <div class="options-container">\n                        ${i}\n                    </div>\n                </div>\n\n                <div class="col-lg-12 mb-2">\n                    <div class="layer__option-title title_pink text-center">Декор:</div>\n                    <div class="options-container">\n                        ${o}\n                    </div>\n                    \n                </div>\n            </div>\n\n            <div class="col-12 mt-2 mb-2">\n                <button class="button button_contrast button_remove-layer disabled">Удалить ярус</button>\n            </div>\n        </div>\n    `,t.querySelector(".button_remove-layer").addEventListener("click",(function(){const e=document.querySelectorAll(".layer");5===e.length&&(document.querySelector(".button_add-layer").classList.remove("disabled"),document.querySelector(".button_add-layer").classList.add("button_center")),1!==e.length&&t.remove(),updateLayerNumbers(),calculateTotal()})),t.querySelectorAll(".option__input").forEach((e=>{e.addEventListener("change",calculateTotal)})),t.querySelectorAll(".custom-text").forEach((e=>{e.addEventListener("change",(()=>{e.value&&(e.parentElement.parentElement.querySelector(".option__input").checked=!0,calculateTotal())}))})),t.querySelectorAll(".layer__header").forEach((e=>{e.addEventListener("click",(()=>{t.querySelector(".layer__title-arrow").classList.toggle("layer__title-arrow_hidden"),t.querySelector(".layer__options").classList.toggle("layer__options_hidden")}))})),t.querySelectorAll(".options-container").forEach((e=>{e.addEventListener("mousedown",(t=>{function n(t){dragging(t,e)}dragStart(t,e),window.addEventListener("mousemove",n),window.addEventListener("mouseup",(function t(){dragStop(e),window.removeEventListener("mousemove",n),window.removeEventListener("mouseup",t)}))})),e.addEventListener("click",(e=>{isDragging&&(e.preventDefault(),e.stopPropagation())})),e.addEventListener("touchstart",(t=>dragStart(t,e))),e.addEventListener("touchmove",(t=>dragging(t,e))),e.addEventListener("touchend",(()=>dragStop(e)))})),document.getElementById("layers-container").appendChild(t),updateLayerNumbers(),calculateTotal()}function rangeInput(e){const t=e.nextElementSibling,n=e.value,a=e.min,i=e.max,o=100-(i-n)/(i-a)*100+"%";t.querySelector(".layer__weight-text").innerText=`${n} кг`,t.style.left=`${o}`,t.style.transform=`translateX(-${o})`,e.style.backgroundSize=`${o}`,calculateTotal()}function valueRound(e){e.value>10&&(e.value=10),e.value<.5&&(e.value=.5),e.value<1&&(e.value=Math.round(10*e.value)/10)}function updateLayerNumbers(){const e=document.querySelectorAll(".layer");e.length>=2?e.forEach(((e,t)=>{e.querySelector(".button_remove-layer").classList.remove("disabled"),e.querySelector(".button_remove-layer").classList.add("button_center")})):e.forEach(((e,t)=>{e.querySelector(".button_remove-layer").classList.add("disabled"),e.querySelector(".button_remove-layer").classList.remove("button_center")})),e.forEach(((e,t)=>{e.querySelector(".layer__title").textContent=`Ярус ${t+1}`,e.id=`layer_${t+1}`,e.querySelectorAll(".layer__base").forEach((e=>{e.name=`filling__${t+1}`})),e.querySelectorAll(".layer__shape").forEach((e=>{e.name=`shapes-${t+1}`})),e.querySelectorAll("layer__ingredient").forEach((e=>{e.name=`ingredients-${t+1}`})),e.querySelectorAll("layer__decor").forEach((e=>{e.name=`decor-${t+1}`}))}))}function calculateTotal(){let e=0,t=0,n=[],a=0;document.querySelectorAll(".layer").forEach((i=>{a++;let o={filling:"",shape:"",ingredients:[],decorations:[],weight:0,price:0};const l=i.querySelector(".layer__base:checked");l&&(o.filling=l.nextElementSibling.querySelector(".option__name").textContent.trim(),o.price+=parseFloat(l.getAttribute("data-price"))||0,o.weight=parseFloat(i.querySelector(".layer__weight").value)||1,t+=Math.round(100*o.weight)/100,o.price*=o.weight);const r=i.querySelector(".layer__shape:checked");r.value.includes("custom")?o.shape=r.nextElementSibling.querySelector(".custom-text").value:o.shape=r.nextElementSibling.querySelector(".option__name").textContent.trim();i.querySelectorAll(".layer__ingredient:checked").forEach((e=>{e.value.includes("custom")?o.ingredients.push(e.nextElementSibling.querySelector(".custom-text").value):o.ingredients.push(e.nextElementSibling.querySelector(".option__name").textContent.trim()),o.price+=parseFloat(e.getAttribute("data-price"))||0}));i.querySelectorAll(".layer__decor:checked").forEach((e=>{e.value.includes("custom")?o.decorations.push(e.nextElementSibling.querySelector(".custom-text").value):o.decorations.push(e.nextElementSibling.querySelector(".option__name").textContent.trim()),o.price+=parseFloat(e.getAttribute("data-price"))||0})),n.push(o),e+=o.price})),document.getElementById("cake-info__details").textContent=`Итого: ярусов ${a}`;let i=n.map(((e,t)=>`\n            <div class="cake-info__layer box-shadow">\n                <div class="cake-info__layer-title">Ярус ${t+1}:</div>\n                <div class="cake-info__layer-text">Наполнитель: ${e.filling}</div>\n                <div class="cake-info__layer-text">Форма яруса: ${e.shape}</div>\n                <div class="cake-info__layer-text">Начинка: ${e.ingredients.join(", ")||"-"}</div>\n                <div class="cake-info__layer-text">Декор: ${e.decorations.join(", ")||"-"}</div>\n                <div class="cake-info__layer-text">Вес яруса: ${e.weight} кг</div>\n                <a class="cake-info__layer-link" href="#layer_${t+1}">Изменить</a>\n            </div>\n        `)).join("");document.getElementById("cake-info__layers-info").innerHTML=i,document.getElementById("cake-info__weight").textContent=`Общий вес торта: ${t} кг`,document.getElementById("cake-info__price").textContent=`Примерная цена: ${e} руб.`}